// Copyright (c) 2025 YiZhonghua<zhyi@dpai.com>. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
import std/io::println
import std/debug::assert
import core/types::Addr

shape Data (
    id: i32
)

// Toka 返回类型通常直接写类型名，共享属性由实现决定
fn create_data(id: i32) -> ~Data {
    auto ~p = new Data(id = id)
    println("Creating data, addr:{} p.id:{}", *p as Addr, p.id)
    return ~p 
}

// 形态前缀放在变量名前面
fn consume_data(~p: Data) {
    println("Consuming data, addr:{} p.id:{}", *p as Addr, p.id)
    assert(p.id == 202, "consume_data received value id mismatch")
}

fn consume_data_raw(*p: Data) {
    println("consume_data_raw data, addr:{} p.id:{}", *p as Addr, p.id)
    assert(p.id == 303, "consume_data received value id mismatch")
}

fn main() -> i32 {
    println("Testing Shared RC Logic...")

    auto *p0 = unsafe alloc Data(id = 303)
    consume_data_raw(*p0)
    println("After consume_data_raw, p0.id={}", p0.id)
    assert(p0.id == 303, "Original p0 was freed prematurely")
    unsafe free *p0

    // 测试点 2：作为参数传递时不应提前释放原引用
    auto ~p1 = new Data(id = 202)
    consume_data(~p1)
    println("After consume_data, p1.id={}", p1.id)
    assert(p1.id == 202, "Original p1 was freed prematurely")

    // 测试点 1：返回值的所有权管理
    auto ~p2 = create_data(101)
    println("Received p2, addr:{} p2.id:{}", *p2 as Addr, p2.id)
    assert(p2.id == 101, "Return value id mismatch")

    println("Shared RC Logic Test Passed.")
    
    return 0
}
